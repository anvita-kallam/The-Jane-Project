{% extends "base.html" %}

{% block title %}Add Center - Jane Project{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 30px;
    }
    
    .geocoding-status {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
    }
    
    .geocoding-loading {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        color: #1976d2;
    }
    
    .geocoding-success {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        color: #2e7d32;
    }
    
    .geocoding-error {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #c62828;
    }
    
    .coordinates-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin: 15px 0;
    }
    
    .service-input-group {
        margin-bottom: 10px;
    }
    
    .remove-service {
        color: #dc3545;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .remove-service:hover {
        color: #c82333;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-plus-circle me-2"></i>
            Add New Center
        </h1>
        <p class="lead mb-4">
            Add a new Crisis Pregnancy Center to our database. We'll automatically geocode the address 
            and help you provide comprehensive information about the center's services.
        </p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="form-section">
            <form method="POST" id="centerForm">
                {{ form.hidden_tag() }}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.name.id }}" class="form-label">
                                <i class="fas fa-building me-2"></i>Center Name *
                            </label>
                            {{ form.name(class="form-control", placeholder="Enter center name") }}
                            {% if form.name.errors %}
                                <div class="text-danger">
                                    {% for error in form.name.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.phone.id }}" class="form-label">
                                <i class="fas fa-phone me-2"></i>Phone Number
                            </label>
                            {{ form.phone(class="form-control", placeholder="(555) 123-4567") }}
                            {% if form.phone.errors %}
                                <div class="text-danger">
                                    {% for error in form.phone.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.address.id }}" class="form-label">
                        <i class="fas fa-map-marker-alt me-2"></i>Address *
                    </label>
                    {{ form.address(class="form-control", placeholder="Enter full address (street, city, state, zip)") }}
                    {% if form.address.errors %}
                        <div class="text-danger">
                            {% for error in form.address.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Enter the complete address for accurate geocoding and mapping.
                    </div>
                </div>
                
                <!-- Geocoding Status -->
                <div id="geocodingStatus" class="geocoding-status" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Geocoding address...</span>
                    </div>
                </div>
                
                <!-- Coordinates Display -->
                <div id="coordinatesDisplay" class="coordinates-display" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Latitude:</strong> <span id="latitudeDisplay"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Longitude:</strong> <span id="longitudeDisplay"></span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-check-circle me-1"></i>
                            Address successfully geocoded! These coordinates will be used for mapping.
                        </small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.website.id }}" class="form-label">
                        <i class="fas fa-globe me-2"></i>Website
                    </label>
                    {{ form.website(class="form-control", placeholder="https://www.example.com") }}
                    {% if form.website.errors %}
                        <div class="text-danger">
                            {% for error in form.website.errors %}
                                <small>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-4">
                    <label class="form-label">
                        <i class="fas fa-hands-helping me-2"></i>Services Offered
                    </label>
                    <div id="servicesContainer">
                        <div class="service-input-group">
                            <div class="input-group">
                                <input type="text" class="form-control service-input" placeholder="Enter a service (e.g., Pregnancy Tests, Ultrasounds, Counseling)">
                                <button type="button" class="btn btn-outline-danger remove-service" onclick="removeService(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addService()">
                        <i class="fas fa-plus me-1"></i>Add Another Service
                    </button>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        List the main services and programs offered by this center.
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('centers') }}" class="btn btn-outline-secondary me-md-2">
                        <i class="fas fa-arrow-left me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-2"></i>Add Center
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 bg-light">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-lightbulb me-2"></i>
                    Tips for Adding Centers
                </h5>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Complete Address:</strong> Include street, city, state, and ZIP code
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Accurate Services:</strong> List all major programs and services
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Contact Info:</strong> Provide phone and website when available
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Verification:</strong> We'll automatically geocode and verify the address
                    </li>
                </ul>
                
                <hr>
                
                <h6 class="text-muted">Example Services:</h6>
                <div class="bg-white p-3 rounded">
                    <ul class="list-unstyled mb-0">
                        <li><small class="text-muted">â€¢ Pregnancy Tests</small></li>
                        <li><small class="text-muted">â€¢ Ultrasounds</small></li>
                        <li><small class="text-muted">â€¢ Counseling</small></li>
                        <li><small class="text-muted">â€¢ Adoption Information</small></li>
                        <li><small class="text-muted">â€¢ Material Aid</small></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="card border-0 bg-info text-white mt-3">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-map me-2"></i>
                    Geocoding Information
                </h6>
                <p class="card-text small">
                    Our system automatically converts addresses to geographic coordinates 
                    using OpenStreetMap data. This ensures accurate placement on our interactive map.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let coordinates = null;

// Add service input field
function addService() {
    const container = document.getElementById('servicesContainer');
    const serviceGroup = document.createElement('div');
    serviceGroup.className = 'service-input-group';
    serviceGroup.innerHTML = `
        <div class="input-group">
            <input type="text" class="form-control service-input" placeholder="Enter a service (e.g., Pregnancy Tests, Ultrasounds, Counseling)">
            <button type="button" class="btn btn-outline-danger remove-service" onclick="removeService(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    container.appendChild(serviceGroup);
}

// Remove service input field
function removeService(button) {
    const serviceGroup = button.closest('.service-input-group');
    if (document.querySelectorAll('.service-input-group').length > 1) {
        serviceGroup.remove();
    }
}

// Geocode address when address field changes
document.getElementById('{{ form.address.id }}').addEventListener('blur', function() {
    const address = this.value.trim();
    if (address.length > 10) {
        geocodeAddress(address);
    }
});

// Geocode address using OpenStreetMap Nominatim
async function geocodeAddress(address) {
    const statusDiv = document.getElementById('geocodingStatus');
    const coordinatesDiv = document.getElementById('coordinatesDisplay');
    
    // Show loading status
    statusDiv.style.display = 'block';
    statusDiv.className = 'geocoding-status geocoding-loading';
    statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </span>
            <span>Geocoding address...</span>
        </div>
    `;
    
    // Hide coordinates display
    coordinatesDiv.style.display = 'none';
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
        const data = await response.json();
        
        if (data && data.length > 0) {
            const location = data[0];
            coordinates = {
                lat: parseFloat(location.lat),
                lon: parseFloat(location.lon)
            };
            
            // Show success status
            statusDiv.className = 'geocoding-status geocoding-success';
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <span>Address successfully geocoded!</span>
                </div>
            `;
            
            // Show coordinates
            document.getElementById('latitudeDisplay').textContent = coordinates.lat.toFixed(6);
            document.getElementById('longitudeDisplay').textContent = coordinates.lon.toFixed(6);
            coordinatesDiv.style.display = 'block';
            
        } else {
            throw new Error('No results found');
        }
        
    } catch (error) {
        // Show error status
        statusDiv.className = 'geocoding-status geocoding-error';
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span>Could not geocode address. Please check the address format.</span>
            </div>
        `;
        coordinates = null;
    }
}

// Form submission handler
document.getElementById('centerForm').addEventListener('submit', function(e) {
    const address = document.getElementById('{{ form.address.id }}').value.trim();
    const submitBtn = document.getElementById('submitBtn');
    
    if (!coordinates && address.length > 10) {
        e.preventDefault();
        alert('Please wait for address geocoding to complete before submitting.');
        return;
    }
    
    // Collect services
    const serviceInputs = document.querySelectorAll('.service-input');
    const services = Array.from(serviceInputs)
        .map(input => input.value.trim())
        .filter(service => service.length > 0)
        .join('\n');
    
    // Create hidden input for services
    let servicesInput = document.getElementById('servicesInput');
    if (!servicesInput) {
        servicesInput = document.createElement('input');
        servicesInput.type = 'hidden';
        servicesInput.name = 'services';
        servicesInput.id = 'servicesInput';
        this.appendChild(servicesInput);
    }
    servicesInput.value = services;
    
    // Disable submit button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding Center...';
});

// Auto-resize textarea
document.getElementById('{{ form.address.id }}').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});
</script>
{% endblock %}
